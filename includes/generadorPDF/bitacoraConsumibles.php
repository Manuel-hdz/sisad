<?php
require('fpdf.php');
require("../conexion.inc");
include("../func_fechas.php");
include("../op_operacionesBD.php");

class PDF extends FPDF{

	function Header(){
		//INSERTAR LOGOTIPO DE LA EMPRESA
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		$this->Image('logo-clf.jpg',12,6,30);
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	    
		//DEFINIR EL FORMATO DE LA LETRA
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	    $this->SetFont('Arial','B',7.5);
		$this->SetTextColor(0, 0, 255);
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		
	    //INSERTAR ESPACIO AL INICO DEL RENGLON
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	    $this->Cell(60);
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		
	    //ENCABEZADO DE LA PAGINA
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	    $this->Cell(70,25,'CONFIDENCIAL, PROPIEDAD DE “CONCRETO LANZADO DE FRESNILLO, S.A DE C.V.” PROHIBIDA SU REPRODUCCIÓN TOTAL O PARCIAL.',0,0,'C');
		$this->SetTextColor(78, 97, 40);
		$this->SetFont('Arial','B',20);
		$this->Cell(-70,14,'__________________________________________________',0,0,'C');
		$this->SetTextColor(0, 0, 255);
		$this->SetFont('Arial','B',10);
		
		$this->SetFont('Arial','B',8);
		$this->SetTextColor(51, 51, 153);
		$this->Cell(125,9,'MANUAL DE PROCEDIMIENTOS DE LA CALIDAD',0,0,'R');
		$this->SetFont('Arial','I',7.5);
		$this->Cell(0.09,15,'CONCRETO LANZADO DE FRESNILLO S.A. DE C.V.',0,0,'R');
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		
		//SALTO DE LINEA
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	    $this->Ln(20);
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		
		//TITULO DEL DOCUMENTO, POSICIONADO EN EL ENCABEZADO
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		$this->Cell(10);
		$this->SetFillColor(217,217,217);
		$this->SetDrawColor(0,0,255);
		$this->SetFont('Arial','B',10);
		$this->Cell(120,6,'CONTROL DE CONSUMIBLES DE IMPRESORAS',1,0,'C',1);
		$this->Cell(50,6,'F. 6.3.0 -12',1,0,'C',1);
		$this->Ln();
		
		$this->Cell(10);
		$this->SetFillColor(255,255,255);
		$this->SetFont('Arial','B',10);
		$this->Cell(120,6,'',1,0,'C',1);
		$this->Cell(50,6,'Hoja '.$this->PageNo().' de {nb}',1,0,'C',1);
		$this->Ln(17);
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		
		parent::Header();
	}

	function Footer(){
		//POSICIONAR EL CURSOR RENGLONES ARRIBA DEL FIN DE LA HOJA
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		$this->SetY(-20);
	    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		
		//ESTABLECER FORMATO DE TEXTO PARA EL PIE DE PAGINA
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		$this->SetDrawColor(0,0,255);
		$this->SetTextColor(0, 0, 255);
		$this->SetFont('Arial','',7);
		$this->Cell(190,0.5,'','TB',1,'C',0);
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		
		//DATOS QUE SE MOSTRARAN EN EL PIE DE PAGINA
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		$this->Cell(190,2,'',0,1,'C',0);
		$this->Cell(47.5,1,'Fecha Emisión:',0,0,'C',0);
		$this->Cell(47.5,1,'No. de Reviisión',0,0,'C',0);
		$this->Cell(47.5,1,'Fecha de Revisión:',0,0,'C',0); 
		$this->Cell(47.5,1,'Página '.$this->PageNo().' de {nb}',0,1,'C',0);
		
		$this->Cell(190,2,'',0,1,'C',0);
		$this->Cell(47.5,1,'Octubre, 13',0,0,'C',0);
		$this->Cell(47.5,1,'00',0,0,'C',0);
		$this->Cell(47.5,1,'Octubre, 13',0,0,'C',0); 
		$this->Cell(47.5,1,'',0,1,'C',0);
		
		$this->Cell(190,2,'',0,1,'C',0);
		$this->Cell(47.5,1,'',0,0,'C',0);
		$this->Cell(47.5,1,'',0,0,'C',0);
		$this->Cell(47.5,1,'',0,0,'C',0); 
		$this->Cell(47.5,1,'F. 6.3.0 -09/ Rev. 01',0,1,'C',0);
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	}

}

	//CREACION DEL PDF Y SUS CARACTERISTICAS
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	$pdf=new PDF('P','mm','Letter');
	$pdf->AliasNbPages();
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	//CUERPO DEL DOCUMENTO
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	$id_cons = $_GET["consumible"];
	$fecha_ini = $_GET['fecI'];
	$fecha_fin = $_GET['fecF'];
	$fechas = $_GET['fec'];
	
	$conec = conecta("bd_sistemas");
	if($id_cons != "TODOS"){
		$desc_titulo = obtenerDatoConsumible($id_cons,"descripcion")." ".obtenerDatoConsumible($id_cons,"color");
		$stm_sql = "SELECT T2.descripcion, T2.color, T1.fecha, T1.cantidad, T1.tipo, T1.departamento, T1.empleado
					FROM bitacora_consumibles AS T1
					JOIN consumibles AS T2
					USING ( id_consumibles ) 
					WHERE T1.id_consumibles = '$id_cons'";
		if($fechas == "SI"){
			$stm_sql .= " AND T1.fecha BETWEEN '$fecha_ini' AND '$fecha_fin'";
		}
		$stm_sql .= " ORDER BY T2.descripcion,T2.color,T1.fecha";
	}
	else {
		$stm_sql = "SELECT T2.descripcion, T2.color, T1.fecha, T1.cantidad, T1.tipo, T1.departamento, T1.empleado
					FROM bitacora_consumibles AS T1
					JOIN consumibles AS T2
					USING ( id_consumibles )";
		if($fechas == "SI"){
			$stm_sql .= " WHERE T1.fecha BETWEEN '$fecha_ini' AND '$fecha_fin'";
		}
		$stm_sql .= " ORDER BY T2.descripcion,T2.color,T1.fecha";
	}
	
	$rs = mysql_query($stm_sql);
	
	if($rs){
		$renglones = 38;
		$consumible = "";
		$color = "";
		$reg_recorridos = 0;
		
		$r = 0; $g = 0; $b = 0;
		while($datos = mysql_fetch_array($rs)){
			if( ($datos["descripcion"] != $consumible || $datos["color"] != $color) || ($reg_recorridos%$renglones == 0) ){
				$pdf->AddPage();
				
				$pdf->SetFont('Arial','',10);
				$pdf->Write(0,"Código de Consumible: $datos[descripcion]");
				$pdf->Write(0,"            Color: $datos[color]");
				$pdf->Ln(5);
				
				$pdf->SetFillColor(75,172,198);
				$pdf->SetTextColor(255, 255, 255);
				$pdf->SetFont('Arial','B',10);
				$pdf->Cell(10,5,'No',1,0,'C',1);
				$pdf->Cell(20,5,'Fecha',1,0,'C',1);
				$pdf->Cell(7,5,'E/S',1,0,'C',1);
				$pdf->Cell(47,5,'Departamento',1,0,'C',1);
				$pdf->Cell(17,5,'Cantidad',1,0,'C',1);
				$pdf->Cell(90,5,'Nombre',1,1,'C',1);
				
				$r = 218; $g = 238; $b = 243;
				
				if($datos["descripcion"] != $consumible || $datos["color"] != $color)
					$reg_recorridos = 0;
			}
			
			$pdf->SetFillColor($r,$g,$b);
			$pdf->SetTextColor(0, 0, 0);
			$pdf->SetFont('Arial','',10);
			$pdf->Cell(10,5,$reg_recorridos + 1,1,0,'C',1);
			$pdf->Cell(20,5,modFecha($datos['fecha'],1),1,0,'C',1);
			$pdf->Cell(7,5,$datos['tipo'],1,0,'C',1);
			$pdf->Cell(47,5,$datos['departamento'],1,0,'C',1);
			$pdf->Cell(17,5,$datos['cantidad'],1,0,'C',1);
			$pdf->Cell(90,5,$datos['empleado'],1,0,'C',1);
			$pdf->Ln();
			
			$consumible = $datos["descripcion"];
			$color = $datos["color"];
			$reg_recorridos++;
			
			if($reg_recorridos%2==0){
				$r = 218; $g = 238; $b = 243;
			} else {
				$r = 255; $g = 255; $b = 255;
			}
		}
	}
	
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	//AGREGAR DESCRIPCION AL DOCUMENTO CREADO
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	$pdf->SetAuthor("ISC. ARMANDO AYALA ALVARADO");
	$pdf->SetTitle("CONSUMIBLES DE IMPRESION");
	$pdf->SetCreator("DEPARTAMENTO DE SISTEMAS");
	$pdf->SetSubject("CONSUMIBLES DE IMPRESION");
	$pdf->SetKeywords("SISTEMAS. \nDocumento Generado a Partir de la Consulta de Bitacora de Consumibles en el SISAD");
	$num_req='BitConsumibles.pdf';
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	//MOSTRAR EL PDF EN PANTALLA
	$pdf->Output($num_req,"F");
	header('Location: '.$num_req);
	
	borrarArchivos();
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	//BORRA LOS ARCHIVOS TEMPORALES CREADOS
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	function borrarArchivos(){
		$t=time();
		$h=opendir('.');
		while ($file=readdir($h)){
			if (substr($file,-4)=='.pdf'){
				if($t-filemtime($file)>1)
					@unlink($file);
			}
		}
		closedir($h);
	}
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	//OBTIENE INFORMACION DEL CONSUMIBLE DE IMPRESION
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	function obtenerDatoConsumible($id,$busqueda){
		$conec = conecta("bd_sistemas");
		$stm_sql = "SELECT $busqueda FROM consumibles WHERE id_consumibles = '$id'";
		
		$rs = mysql_query($stm_sql);
		if($rs){
			if($datos = mysql_fetch_array($rs)){
				return $datos[0];
			} else {
				return "Sin Dato";
			}
		} else {
			return "Sin Dato";
		}
	}
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
?>